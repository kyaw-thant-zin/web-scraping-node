!function(){"use strict";function e(e,t,n,o){return new(n||(n=Promise))((function(r,s){function c(e){try{a(o.next(e))}catch(e){s(e)}}function i(e){try{a(o.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,i)}a((o=o.apply(e,t||[])).next())}))}var t="service_worker",n="general_fetch",o="__PNS_RUNTIME_SW_EVENT__",r="__PNS_RUNTIME_SE_ERROR__",s="__PNS_SW_CACHE_KEY__";function c(e,t){try{return new URL(t).searchParams.get(e)}catch(e){return null}}for(var i,a={},l=0,u=["debug","info","verbose","log","error","warn"];l<u.length;l++)i=void 0,i=u[l],a[i]=function(){};const d=(t,n)=>e(void 0,void 0,void 0,(function*(){const o=yield caches.open("pns_runtime_resource");((t,n)=>{e(void 0,void 0,void 0,(function*(){const{url:e}=n,o=c(s,e),r=yield t.keys();for(const e of r){const{url:n}=e;o===c(s,n)&&t.delete(e)}}))})(o,t),yield o.put(t,n)}));function f(t){const{request:n}=t,{url:o,method:r}=n;"GET"===r.toUpperCase()&&"1"===c("__PNS_SW_CACHE__",o)&&t.respondWith((t=>e(void 0,void 0,void 0,(function*(){const e=yield caches.match(t);if(e)return e;const n=yield fetch(t);return d(t,n.clone()),n})))(n))}function h(n,s){return e(this,void 0,void 0,(function*(){const e=yield self.clients.get(n);if(e)try{s instanceof Error?e.postMessage({event:r,error:s}):e.postMessage({event:o,data:Object.assign(Object.assign({},s),{source:t})})}catch(e){a.error("RuntimeMonitor fail to post message",e.message)}}))}const v=new class{constructor(){this.fetchEventHandlers=[]}emitFetchEvent(t){const{request:n,clientId:o}=t;if(!o)return;let r=!1;const s=()=>r=!0,c=t=>e(this,void 0,void 0,(function*(){return yield h(o,t)}));for(const e of this.fetchEventHandlers)try{e({request:n,blockRequest:s,sendToMainThread:c})}catch(e){a.error("[RuntimeWorker] handler error",e),h(o,e)}r?t.respondWith(null):f(t)}onFetch(e){this.fetchEventHandlers.includes(e)||this.fetchEventHandlers.push(e)}},_=Object.values({TTP:"mon.us.tiktokv.com",NON_TTP:"mon-va.byteoversea.com"}),p=new RegExp("(cookie|auth|jwt|token|key|ticket|secret|credential|session|^accept$|^content-type$|password|^sec-|^user-agent$)","i"),m=new RegExp("(bearer|session)","i");var y=Object.freeze({__proto__:null,generalReportPlugin:()=>({name:"GeneralReportPlugin",setup:t=>{t.onFetch((({request:t,sendToMainThread:o})=>e(void 0,void 0,void 0,(function*(){const{url:e,referrer:r,headers:s,method:c}=t,i={};s.forEach(((e,t)=>{((e,t)=>!(!e||!t)&&(p.test(e)||m.test(t)))(t,e)||(i[t]=e)}));const a=s.get("Content-Type")||"";let l="",u="",d="";try{const t=new URL(e);if(_.includes(t.host))return;l=t.search,u=t.host,d=t.pathname}catch(e){console.error(e)}let f={};try{const e=t.clone();if(["POST","PUT"].includes(c))if(a.includes("application/json"))f=yield e.json();else if(a.includes("application/x-www-form-urlencoded")){const t=yield e.text();new URLSearchParams(t).forEach(((e,t)=>{Reflect.set(f,t,e)}))}else if(a.includes("multipart/form-data")){(yield e.formData()).forEach(((e,t)=>{e instanceof File?Reflect.set(f,t,"file"):e instanceof Blob?Reflect.set(f,t,"blob"):Reflect.set(f,t,typeof e)}))}}catch(e){}o({eventName:n,eventDetail:{request_url:e,request_host:u,request_path:d,header_names:Array.from(s.keys()).join(","),header_map:i,referrer:r,search:l,body:f,method:c,contentType:a}})}))))}})});Object.values(y).forEach((e=>{e().setup(v)})),self.addEventListener("fetch",(e=>{v.emitFetchEvent(e)}))}();
